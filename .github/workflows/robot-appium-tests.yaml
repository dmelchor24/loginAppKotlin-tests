name: Mobile Tests (Appium + Robot)

on:
  repository_dispatch:
    types: [run-mobile-tests]

  workflow_dispatch:
    inputs:
      apk_path:
        description: "Ruta o nombre del APK"
        required: true
        default: "app-debug.apk"

      env:
        description: "Entorno de ejecuci√≥n"
        required: true
        default: "ci"

permissions:
  contents: read

jobs:
  mobile-tests:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repo de tests
    - name: Checkout repo tests
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Configurar Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£ Instalar dependencias Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework
        pip install robotframework-appiumlibrary
        pip install Appium-Python-Client

    # 4Ô∏è‚É£ Configurar Java (necesario para Android)
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"

    # 5Ô∏è‚É£ Instalar Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 6Ô∏è‚É£ Instalar Appium
    - name: Install Appium
      run: |
        npm install -g appium
        appium driver install uiautomator2
    
    # 7Ô∏è‚É£ Instalar jq
    - name: Install jq
      run: sudo apt-get install -y jq

    # 8Ô∏è‚É£ Descargar APK desde repo del app
    - name: Download APK from app repo
      env:
        GH_TOKEN: ${{ secrets.REPO_LOGINAPP_TESTS }}
        APP_REPO: ${{ github.event.client_payload.app_repo }}
        RUN_ID: ${{ github.event.client_payload.run_id }}
        ARTIFACT_NAME: ${{ github.event.client_payload.artifact_name }}
      run: |
        mkdir -p apk

        ARTIFACT_ID=$(curl -s \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/$APP_REPO/actions/runs/$RUN_ID/artifacts \
          | jq -r ".artifacts[] | select(.name==\"$ARTIFACT_NAME\") | .id")

        curl -L \
          -H "Authorization: Bearer $GH_TOKEN" \
          -o artifact.zip \
          https://api.github.com/repos/$APP_REPO/actions/artifacts/$ARTIFACT_ID/zip

        unzip artifact.zip -d apk

    # 9Ô∏è‚É£ Validar APK descargado
    - name: Verify APK
      run: |
        ls -la apk

    # üîü Iniciar emulador Android
    - name: Start Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        arch: x86_64
        profile: pixel
        avd-name: appium
        script: echo "Emulator started"

    # 1Ô∏è‚É£1Ô∏è‚É£ Ejecutar tests Robot Framework
    - name: Run Robot Tests
      env:
        ENV: ci
        APK_PATH: apk/${{ github.event.client_payload.apk_path }}
      run: |
        python scripts/execute-tests.py

    # 1Ô∏è‚É£2Ô∏è‚É£ Publicar reportes
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      with:
        name: robot-reports
        path: reports
