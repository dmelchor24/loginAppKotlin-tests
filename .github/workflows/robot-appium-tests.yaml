name: Mobile Tests (Appium + Robot)

on:
  repository_dispatch:
    types: [run-mobile-tests]

permissions:
  contents: read
  actions: read

jobs:
  mobile-tests:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repo de tests
    - name: Checkout repo tests
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£ Instalar dependencias Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework
        pip install robotframework-appiumlibrary
        pip install Appium-Python-Client

    # 4Ô∏è‚É£ Setup Java
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # 5Ô∏è‚É£ Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 6Ô∏è‚É£ Setup Node.js (MOVIDO AQU√ç - antes del emulador)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # 7Ô∏è‚É£ Install Appium (MOVIDO AQU√ç - antes del emulador)
    - name: Install Appium
      run: |
        npm install -g appium
        appium driver install uiautomator2

    # 8Ô∏è‚É£ Descargar APK EXACTO del repo APP
    - name: Download APK artifact from App repo
      uses: actions/download-artifact@v4
      with:
        name: app-debug-apk
        path: apk
        repository: ${{ github.event.client_payload.app_repo }}
        run-id: ${{ github.event.client_payload.run_id }}
        github-token: ${{ secrets.REPO_LOGINAPP_TESTS }}

    # 9Ô∏è‚É£ Verificar APK
    - name: Verify APK
      run: |
        ls -lh apk

    # üîü Iniciar Emulador y Ejecutar TODOS los tests
    - name: Start Android Emulator and Run Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: x86_64
        target: default
        profile: pixel
        avd-name: appium
        cores: 2
        ram-size: 2048M
        force-avd-creation: true
        emulator-boot-timeout: 1200
        disable-animations: true
        emulator-options: -no-window -no-snapshot -noaudio -no-boot-anim
        disable-linux-hw-accel: true
        script: |
          echo "üöÄ Emulador iniciado, esperando confirmaci√≥n..."
          until adb shell getprop sys.boot_completed | grep -m 1 1; do
            echo "‚è≥ Esperando boot completo..."
            sleep 5
          done
          echo "‚úÖ Emulador listo!"
          
          # Desactivar animaciones
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0
          adb shell input keyevent 82
          echo "‚úÖ Animaciones desactivadas"
          
          # Estabilizar ADB
          adb kill-server
          adb start-server
          adb wait-for-device
          adb devices
          echo "‚úÖ ADB estabilizado"
          
          # Instalar APK
          echo "üì¶ Instalando APK..."
          adb install -r apk/app-debug.apk
          echo "‚úÖ APK instalado"
          
          # Iniciar Appium en background
          echo "üîß Iniciando servidor Appium..."
          appium --log-level error &
          APPIUM_PID=$!
          sleep 15
          echo "‚úÖ Appium iniciado (PID: $APPIUM_PID)"
          
          # Ejecutar tests
          echo "ü§ñ Ejecutando Robot Framework tests..."
          python scripts/execute-tests.py
          TEST_EXIT_CODE=$?
          
          # Detener Appium
          echo "üõë Deteniendo Appium..."
          kill $APPIUM_PID || true
          
          echo "‚úÖ Tests completados con c√≥digo: $TEST_EXIT_CODE"
          exit $TEST_EXIT_CODE
      env:
        ENV: ci
        APK_PATH: apk/app-debug.apk

    # 1Ô∏è‚É£1Ô∏è‚É£ Subir reportes (esto S√ç puede ir fuera)
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: robot-reports
        path: reports