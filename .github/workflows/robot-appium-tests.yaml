# WORKFLOW DE GITHUB ACTIONS - PRUEBAS M√ìVILES AUTOMATIZADAS
name: Mobile Tests (Docker + Appium + Robot)

# Este workflow se ejecuta cuando recibe un evento 'repository_dispatch' despu√©s de un build exitoso
on:
  repository_dispatch:
    types: [run-mobile-tests]  # Tipo espec√≠fico de evento que activa este workflow

# Permisos m√≠nimos necesarios para el funcionamiento del workflow
permissions:
  actions: read      # Leer informaci√≥n de actions y workflows
  contents: write    # Escribir en el repositorio (para publicar reportes)

jobs:
  android-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # Paso 1: Descargar el c√≥digo fuente del repositorio de pruebas (este repositorio)
      - name: Checkout repo tests
        uses: actions/checkout@v4
      # Paso 2: Ejecuci√≥n de Docker
      - name: Build & run tests
        run: |
          docker compose build
          docker compose up --abort-on-container-exit
      # Paso 3: Subir todos los reportes generados como artifacts de GitHub Actions
      # Se ejecuta siempre (incluso si las pruebas fallan) para poder analizar resultados
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-reports
          path: reports
      # Paso 4: Verificar qu√© archivos se generaron en el directorio docs antes de publicar
      - name: Debug docs content
        run: |
          echo "Contenido del directorio docs:"
          ls -la docs

      # Paso 13: Publicar los reportes en GitHub Pages para acceso web f√°cil
      # Configura Git y hace commit de los archivos generados en docs/
      - name: Publish Robot Framework report to GitHub Pages
        if: always()                      # Ejecutar siempre para tener reportes disponibles
        run: |
          # Configurar Git con usuario de GitHub Actions
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Verificar estado del repositorio
          git status
          
          # Agregar archivos del directorio docs al staging area
          git add docs

          # Verificar si hay cambios reales para commitear
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No hay cambios reales en docs/ - no se requiere commit"
          else
            echo "‚úÖ Commiteando cambios en reportes..."
            git commit -m "ü§ñ Actualizaci√≥n autom√°tica: Reportes de Robot Framework $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "üìÑ Reportes publicados en GitHub Pages"
          fi