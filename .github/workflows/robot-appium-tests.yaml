name: Mobile Tests (Appium + Robot)

on:
  repository_dispatch:
    types: [run-mobile-tests]

permissions:
  contents: read
  actions: read

jobs:
  mobile-tests:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repo de tests
    - name: Checkout repo tests
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£ Instalar dependencias Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework
        pip install robotframework-appiumlibrary
        pip install Appium-Python-Client

    # 4Ô∏è‚É£ Setup Java
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # 5Ô∏è‚É£ Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 7Ô∏è‚É£ Descargar APK EXACTO del repo APP
    - name: Download APK artifact from App repo
      uses: actions/download-artifact@v4
      with:
        name: app-debug-apk
        path: apk
        repository: ${{ github.event.client_payload.app_repo }}
        run-id: ${{ github.event.client_payload.run_id }}
        github-token: ${{ secrets.REPO_LOGINAPP_TESTS }}

    # 8Ô∏è‚É£ Verificar APK
    - name: Verify APK
      run: |
        ls -lh apk

    # 9Ô∏è‚É£ Iniciar Emulador
    - name: Start Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: x86_64
        target: default
        profile: pixel
        avd-name: appium
        cores: 2
        ram-size: 2048M
        force-avd-creation: true
        emulator-boot-timeout: 1200
        disable-animations: true
        emulator-options: >
          -no-window
          -no-snapshot
          -noaudio
          -no-boot-anim
        emulator-port: 5554
        disable-linux-hw-accel: true
        enable-hw-keyboard: false
        channel: stable
        script: |
          echo "Esperando a que el emulador arranque..."
          until adb -s emulator-5554 shell getprop sys.boot_completed | grep -m 1 1; do
            sleep 5
          done
          echo "¬°Emulador listo!"
          adb -s emulator-5554 shell settings put global window_animation_scale 0
          adb -s emulator-5554 shell settings put global transition_animation_scale 0
          adb -s emulator-5554 shell settings put global animator_duration_scale 0
          echo "Emulador configurado correctamente."

    # üîß ADB HARDENING
    - name: Stabilize ADB
      run: |
        adb kill-server
        adb start-server
        adb wait-for-device
        adb devices
        adb shell getprop sys.boot_completed
        adb shell input keyevent 82

    # üì¶ INSTALL APK
    - name: Install APK
      run: |
        adb install -r apk/app-debug.apk
    
    # Intalaci√≥n de Node
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # 6Ô∏è‚É£ Install Appium
    - name: Install Appium
      run: |
        npm install -g appium
        appium driver install uiautomator2
        appium --log-level error &
        sleep 15

    # üîü Ejecutar Robot Tests
    - name: Run Robot Tests
      env:
        ENV: ci
        APK_PATH: apk/app-debug.apk
      run: |
        python scripts/execute-tests.py

    # 1Ô∏è‚É£1Ô∏è‚É£ Subir reportes
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      with:
        name: robot-reports
        path: reports