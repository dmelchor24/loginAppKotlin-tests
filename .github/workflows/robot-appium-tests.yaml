name: Mobile Tests (Appium + Robot)

on:
  repository_dispatch:
    types: [run-mobile-tests]

permissions:
  actions: read
  contents: write

jobs:
  mobile-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    # 1Ô∏è‚É£ Checkout repo de tests
    - name: Checkout repo tests
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£ Instalar dependencias Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework
        pip install robotframework-appiumlibrary
        pip install Appium-Python-Client

    # 4Ô∏è‚É£ Setup Java
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # 5Ô∏è‚É£ Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 6Ô∏è‚É£ Setup Node.js (MOVIDO AQU√ç - antes del emulador)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    # 7Ô∏è‚É£ Install Appium (MOVIDO AQU√ç - antes del emulador)
    - name: Install Appium
      run: |
        npm install -g appium@3.1.2
        appium driver install uiautomator2
        appium --version

    # 8Ô∏è‚É£ Descargar APK EXACTO del repo APP
    - name: Download APK artifact from App repo
      uses: actions/download-artifact@v4
      with:
        name: app-debug-apk
        path: apk
        repository: ${{ github.event.client_payload.app_repo }}
        run-id: ${{ github.event.client_payload.run_id }}
        github-token: ${{ secrets.REPO_LOGINAPP_TESTS }}

    # 9Ô∏è‚É£ Verificar APK
    - name: Verify APK
      run: |
        ls -lh apk

    # üîü Iniciar Emulador y Ejecutar TODOS los tests
    - name: Start Android Emulator and Run Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: x86_64
        target: default
        profile: pixel
        avd-name: appium
        cores: 2
        ram-size: 2048M
        force-avd-creation: true
        emulator-boot-timeout: 1200
        disable-animations: true
        emulator-options: -no-window -no-snapshot -noaudio -no-boot-anim
        disable-linux-hw-accel: true
        script: chmod +x ./scripts/run-tests.sh && ./scripts/run-tests.sh
      env:
        ENV: ci
        APK_PATH: apk/app-debug.apk

    # 1Ô∏è‚É£1Ô∏è‚É£ Subir reportes (esto S√ç puede ir fuera)
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: robot-reports
        path: reports

    - name: Publish Robot Framework report to GitHub Pages    # Paso 7: Se publica el reporte en GitHub Pages
      if: always()
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add docs
        git commit -m "Actualizacion: Reporte de Robot Framework" || echo "Sin ningun cambio"
        git push