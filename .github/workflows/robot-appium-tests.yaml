# WORKFLOW DE GITHUB ACTIONS - PRUEBAS M√ìVILES AUTOMATIZADAS
name: Mobile Tests (Docker + Appium + Robot)

# Este workflow se ejecuta cuando recibe un evento 'repository_dispatch' despu√©s de un build exitoso
on:
  repository_dispatch:
    types: [run-mobile-tests]  # Tipo espec√≠fico de evento que activa este workflow

# Permisos m√≠nimos necesarios para el funcionamiento del workflow
permissions:
  actions: read      # Leer informaci√≥n de actions y workflows
  contents: write    # Escribir en el repositorio (para publicar reportes)

jobs:
  android-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # Paso 1: Descargar el c√≥digo fuente del repositorio de pruebas (este repositorio)
      - name: Checkout repo tests
        uses: actions/checkout@v4
      
      # Paso 2: Descargar el APK generado por el workflow del repositorio de la aplicaci√≥n
      # Utiliza el token de acceso para descargar artifacts de repositorios privados
      - name: Download APK artifact from App repo
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk                                       # Nombre del artifact en el repo de la app
          path: apk                                                 # Directorio local donde guardar el APK
          repository: ${{ github.event.client_payload.app_repo }}   # Repo fuente (enviado en el dispatch)
          run-id: ${{ github.event.client_payload.run_id }}         # ID del workflow run (enviado en el dispatch)
          github-token: ${{ secrets.REPO_LOGINAPP_TESTS }}          # Token para acceso entre repositorios
      
      # Paso 3: Verifica que el APK exista
      - name: Verify APK exists
        run: |
          echo "üì¶ Contenido del workspace:"
          ls -R
          if [ ! -f apk/app-debug.apk ]; then
            echo "‚ùå APK no encontrado"
            exit 1
          fi
          echo "‚úÖ APK encontrado"

      - name: Prepare APK for Docker
        run: |
          mv apk/app-debug.apk ./app-debug.apk
          ls -lh app-debug.apk

      # Paso 4: Informaci√≥n de Docker
      - name: Docker info
        run: docker info

      # Paso 4: Ejecuci√≥n de Docker
      - name: Build & run tests
        run: |
          docker compose build
          docker compose up --exit-code-from mobile-tests
      
      # Paso 5: Subir todos los reportes generados como artifacts de GitHub Actions
      # Se ejecuta siempre (incluso si las pruebas fallan) para poder analizar resultados
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-reports
          path: reports
      
      # Paso 6: Verificar qu√© archivos se generaron en el directorio docs antes de publicar
      - name: Debug docs content
        run: |
          echo "Contenido del directorio docs:"
          ls -la docs || echo "‚ö†Ô∏è docs/ no existe a√∫n"

      - name: Cleanup containers
        if: always()
        run: docker compose down

      # Paso 7: Publicar los reportes en GitHub Pages para acceso web f√°cil
      # Configura Git y hace commit de los archivos generados en docs/
      - name: Publish Robot Framework report to GitHub Pages
        if: always()                      # Ejecutar siempre para tener reportes disponibles
        run: |
          # Configurar Git con usuario de GitHub Actions
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Verificar estado del repositorio
          git status
          
          # Agregar archivos del directorio docs al staging area
          git add docs

          # Verificar si hay cambios reales para commitear
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No hay cambios reales en docs/ - no se requiere commit"
          else
            echo "‚úÖ Commiteando cambios en reportes..."
            git commit -m "ü§ñ Actualizaci√≥n autom√°tica: Reportes de Robot Framework $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "üìÑ Reportes publicados en GitHub Pages"
          fi